var Qt=Object.defineProperty;var Vt=(t,e,n)=>e in t?Qt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var C=(t,e,n)=>Vt(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const Zt=["white","black"],ye=["a","b","c","d","e","f","g","h"],ke=["1","2","3","4","5","6","7","8"],Yt=[...ke].reverse(),We=Array.prototype.concat(...ye.map(t=>ke.map(e=>t+e))),B=t=>We[8*t[0]+t[1]],S=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],ft=We.map(S);function Xt(t){let e;const n=()=>(e===void 0&&(e=t()),e);return n.clear=()=>{e=void 0},n}const Jt=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Ue=t=>t==="white"?"black":"white",he=(t,e)=>{const n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i},qe=(t,e)=>t.role===e.role&&t.color===e.color,pe=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],z=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},pt=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},je=(t,e)=>{t.style.visibility=e?"visible":"hidden"},re=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},gt=t=>t.button===2,U=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function mt(t,e,n){const i=S(t);return e||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const oe=(t,e)=>Math.abs(t-e),en=t=>(e,n,i,o)=>oe(e,i)<2&&(t==="white"?o===n+1||n<=1&&o===n+2&&e===i:o===n-1||n>=6&&o===n-2&&e===i),vt=(t,e,n,i)=>{const o=oe(t,n),r=oe(e,i);return o===1&&r===2||o===2&&r===1},bt=(t,e,n,i)=>oe(t,n)===oe(e,i),_t=(t,e,n,i)=>t===n||e===i,wt=(t,e,n,i)=>bt(t,e,n,i)||_t(t,e,n,i),tn=(t,e,n)=>(i,o,r,s)=>oe(i,r)<2&&oe(o,s)<2||n&&o===s&&o===(t==="white"?0:7)&&(i===4&&(r===2&&e.includes(0)||r===6&&e.includes(7))||e.includes(r));function nn(t,e){const n=e==="white"?"1":"8",i=[];for(const[o,r]of t)o[1]===n&&r.color===e&&r.role==="rook"&&i.push(S(o)[0]);return i}function yt(t,e,n){const i=t.get(e);if(!i)return[];const o=S(e),r=i.role,s=r==="pawn"?en(i.color):r==="knight"?vt:r==="bishop"?bt:r==="rook"?_t:r==="queen"?wt:tn(i.color,nn(t,i.color),n);return ft.filter(a=>(o[0]!==a[0]||o[1]!==a[1])&&s(o[0],o[1],a[0],a[1])).map(B)}function O(t,...e){t&&setTimeout(()=>t(...e),1)}function on(t){t.orientation=Ue(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function rn(t,e){for(const[n,i]of e)i?t.pieces.set(n,i):t.pieces.delete(n)}function sn(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[n,i]of t.pieces)i.role==="king"&&i.color===e&&(t.check=n)}function an(t,e,n,i){X(t),t.premovable.current=[e,n],O(t.premovable.events.set,e,n,i)}function Y(t){t.premovable.current&&(t.premovable.current=void 0,O(t.premovable.events.unset))}function ln(t,e,n){Y(t),t.predroppable.current={role:e,key:n},O(t.predroppable.events.set,e,n)}function X(t){const e=t.predroppable;e.current&&(e.current=void 0,O(e.events.unset))}function cn(t,e,n){if(!t.autoCastle)return!1;const i=t.pieces.get(e);if(!i||i.role!=="king")return!1;const o=S(e),r=S(n);if(o[1]!==0&&o[1]!==7||o[1]!==r[1])return!1;o[0]===4&&!t.pieces.has(n)&&(r[0]===6?n=B([7,r[1]]):r[0]===2&&(n=B([0,r[1]])));const s=t.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(n),o[0]<r[0]?(t.pieces.set(B([6,r[1]]),i),t.pieces.set(B([5,r[1]]),s)):(t.pieces.set(B([2,r[1]]),i),t.pieces.set(B([3,r[1]]),s)),!0)}function kt(t,e,n){const i=t.pieces.get(e),o=t.pieces.get(n);if(e===n||!i)return!1;const r=o&&o.color!==i.color?o:void 0;return n===t.selected&&$(t),O(t.events.move,e,n,r),cn(t,e,n)||(t.pieces.set(n,i),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,O(t.events.change),r||!0}function Ge(t,e,n,i){if(t.pieces.has(n))if(i)t.pieces.delete(n);else return!1;return O(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,O(t.events.change),t.movable.dests=void 0,t.turnColor=Ue(t.turnColor),!0}function Et(t,e,n){const i=kt(t,e,n);return i&&(t.movable.dests=void 0,t.turnColor=Ue(t.turnColor),t.animation.current=void 0),i}function Ct(t,e,n){if(Qe(t,e,n)){const i=Et(t,e,n);if(i){const o=t.hold.stop();$(t);const r={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:o};return i!==!0&&(r.captured=i),O(t.movable.events.after,e,n,r),!0}}else if(dn(t,e,n))return an(t,e,n,{ctrlKey:t.stats.ctrlKey}),$(t),!0;return $(t),!1}function St(t,e,n,i){const o=t.pieces.get(e);o&&(un(t,e,n)||i)?(t.pieces.delete(e),Ge(t,o,n,i),O(t.movable.events.afterNewPiece,o.role,n,{premove:!1,predrop:!1})):o&&hn(t,e,n)?ln(t,o.role,n):(Y(t),X(t)),t.pieces.delete(e),$(t)}function Fe(t,e,n){if(O(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){$(t),t.hold.cancel();return}else if((t.selectable.enabled||n)&&t.selected!==e&&Ct(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(Mt(t,e)||Ve(t,e))&&(Pt(t,e),t.hold.start())}function Pt(t,e){t.selected=e,Ve(t,e)?t.premovable.customDests||(t.premovable.dests=yt(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function $(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function Mt(t,e){const n=t.pieces.get(e);return!!n&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}const Qe=(t,e,n)=>{var i,o;return e!==n&&Mt(t,e)&&(t.movable.free||!!(!((o=(i=t.movable.dests)===null||i===void 0?void 0:i.get(e))===null||o===void 0)&&o.includes(n)))};function un(t,e,n){const i=t.pieces.get(e);return!!i&&(e===n||!t.pieces.has(n))&&(t.movable.color==="both"||t.movable.color===i.color&&t.turnColor===i.color)}function Ve(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function dn(t,e,n){var i,o;const r=(o=(i=t.premovable.customDests)===null||i===void 0?void 0:i.get(e))!==null&&o!==void 0?o:yt(t.pieces,e,t.premovable.castle);return e!==n&&Ve(t,e)&&r.includes(n)}function hn(t,e,n){const i=t.pieces.get(e),o=t.pieces.get(n);return!!i&&(!o||o.color!==t.movable.color)&&t.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&t.movable.color===i.color&&t.turnColor!==i.color}function fn(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}function pn(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],i=e[1];let o=!1;if(Qe(t,n,i)){const r=Et(t,n,i);if(r){const s={premove:!0};r!==!0&&(s.captured=r),O(t.movable.events.after,n,i,s),o=!0}}return Y(t),o}function gn(t,e){const n=t.predroppable.current;let i=!1;if(!n)return!1;if(e(n)){const o={role:n.role,color:t.movable.color};Ge(t,o,n.key)&&(O(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return X(t),i}function Ze(t){Y(t),X(t),$(t)}function Je(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Ze(t)}function se(t,e,n){let i=Math.floor(8*(t[0]-n.left)/n.width);e||(i=7-i);let o=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(o=7-o),i>=0&&i<8&&o>=0&&o<8?B([i,o]):void 0}function mn(t,e,n,i){const o=S(t),r=ft.filter(c=>wt(o[0],o[1],c[0],c[1])||vt(o[0],o[1],c[0],c[1])),a=r.map(c=>mt(B(c),n,i)).map(c=>he(e,c)),[,l]=a.reduce((c,u,d)=>c[0]<u?c:[u,d],[a[0],0]);return B(r[l])}const q=t=>t.orientation==="white",xt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",vn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},bn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function It(t){t==="start"&&(t=xt);const e=new Map;let n=7,i=0;for(const o of t)switch(o){case" ":case"[":return e;case"/":if(--n,n<0)return e;i=0;break;case"~":{const r=e.get(B([i-1,n]));r&&(r.promoted=!0);break}default:{const r=o.charCodeAt(0);if(r<57)i+=r-48;else{const s=o.toLowerCase();e.set(B([i,n]),{role:vn[s],color:o===s?"black":"white"}),++i}}}return e}function _n(t){return Yt.map(e=>ye.map(n=>{const i=t.get(n+e);if(i){let o=bn[i.role];return i.color==="white"&&(o=o.toUpperCase()),i.promoted&&(o+="~"),o}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function At(t,e){e.animation&&(Ye(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function Lt(t,e){var n,i,o;if(!((n=e.movable)===null||n===void 0)&&n.dests&&(t.movable.dests=void 0),!((i=e.drawable)===null||i===void 0)&&i.autoShapes&&(t.drawable.autoShapes=[]),Ye(t,e),e.fen&&(t.pieces=It(e.fen),t.drawable.shapes=((o=e.drawable)===null||o===void 0?void 0:o.shapes)||[]),"check"in e&&sn(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Pt(t,t.selected),At(t,e),!t.movable.rookCastle&&t.movable.dests){const r=t.movable.color==="white"?"1":"8",s="e"+r,a=t.movable.dests.get(s),l=t.pieces.get(s);if(!a||!l||l.role!=="king")return;t.movable.dests.set(s,a.filter(c=>!(c==="a"+r&&a.includes("c"+r))&&!(c==="h"+r&&a.includes("g"+r))))}}function Ye(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)&&et(t[n])&&et(e[n])?Ye(t[n],e[n]):t[n]=e[n])}function et(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const ne=(t,e)=>e.animation.enabled?kn(t,e):V(t,e);function V(t,e){const n=t(e);return e.dom.redraw(),n}const Ie=(t,e)=>({key:t,pos:S(t),piece:e}),wn=(t,e)=>e.sort((n,i)=>he(t.pos,n.pos)-he(t.pos,i.pos))[0];function yn(t,e){const n=new Map,i=[],o=new Map,r=[],s=[],a=new Map;let l,c,u;for(const[d,h]of t)a.set(d,Ie(d,h));for(const d of We)l=e.pieces.get(d),c=a.get(d),l?c?qe(l,c.piece)||(r.push(c),s.push(Ie(d,l))):s.push(Ie(d,l)):c&&r.push(c);for(const d of s)c=wn(d,r.filter(h=>qe(d.piece,h.piece))),c&&(u=[c.pos[0]-d.pos[0],c.pos[1]-d.pos[1]],n.set(d.key,u.concat(u)),i.push(c.key));for(const d of r)i.includes(d.key)||o.set(d.key,d.piece);return{anims:n,fadings:o}}function Tt(t,e){const n=t.animation.current;if(n===void 0){t.dom.destroyed||t.dom.redrawNow();return}const i=1-(e-n.start)*n.frequency;if(i<=0)t.animation.current=void 0,t.dom.redrawNow();else{const o=En(i);for(const r of n.plan.anims.values())r[2]=r[0]*o,r[3]=r[1]*o;t.dom.redrawNow(!0),requestAnimationFrame((r=performance.now())=>Tt(t,r))}}function kn(t,e){const n=new Map(e.pieces),i=t(e),o=yn(n,e);if(o.anims.size||o.fadings.size){const r=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:o},r||Tt(e,performance.now())}else e.dom.redraw();return i}const En=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,Cn=["green","red","blue","yellow"];function Sn(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?$(t):Ze(t);const n=re(e),i=se(n,q(t),t.dom.bounds());i&&(t.drawable.current={orig:i,pos:n,brush:In(e),snapToValidMove:t.drawable.defaultSnapToValidMove},Nt(t))}function Nt(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const n=se(e.pos,q(t),t.dom.bounds());n||(e.snapToValidMove=!1);const i=e.snapToValidMove?mn(e.orig,e.pos,q(t),t.dom.bounds()):n;i!==e.mouseSq&&(e.mouseSq=i,e.dest=i!==e.orig?i:void 0,t.dom.redrawNow()),Nt(t)}})}function Pn(t,e){t.drawable.current&&(t.drawable.current.pos=re(e))}function Mn(t){const e=t.drawable.current;e&&(e.mouseSq&&An(t.drawable,e),Rt(t))}function Rt(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function xn(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),Dt(t.drawable))}function In(t){var e;const n=(t.shiftKey||t.ctrlKey)&&gt(t),i=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return Cn[(n?1:0)+(i?2:0)]}function An(t,e){const n=o=>o.orig===e.orig&&o.dest===e.dest,i=t.shapes.find(n);i&&(t.shapes=t.shapes.filter(o=>!n(o))),(!i||i.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),Dt(t)}function Dt(t){t.onChange&&t.onChange(t.shapes)}function Ln(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),i=re(e),o=se(i,q(t),n);if(!o)return;const r=t.pieces.get(o),s=t.selected;if(!s&&t.drawable.enabled&&(t.drawable.eraseOnClick||!r||r.color!==t.turnColor)&&xn(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||r||s||Tn(t,i)))e.preventDefault();else if(e.touches)return;const a=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&Qe(t,t.selected,o)?ne(d=>Fe(d,o),t):Fe(t,o);const c=t.selected===o,u=qt(t,o);if(r&&u&&c&&fn(t,o)){t.draggable.current={orig:o,piece:r,origPos:i,pos:i,started:t.draggable.autoDistance&&t.stats.dragged,element:u,previouslySelected:s,originTarget:e.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const d=t.dom.elements.ghost;d&&(d.className=`ghost ${r.color} ${r.role}`,z(d,pe(n)(S(o),q(t))),je(d,!0)),Xe(t)}else a&&Y(t),l&&X(t);t.dom.redraw()}function Tn(t,e){const n=q(t),i=t.dom.bounds(),o=Math.pow(i.width/8,2);for(const r of t.pieces.keys()){const s=mt(r,n,i);if(he(s,e)<=o)return!0}return!1}function Nn(t,e,n,i){const o="a0";t.pieces.set(o,e),t.dom.redraw();const r=re(n);t.draggable.current={orig:o,piece:e,origPos:r,pos:r,started:!0,element:()=>qt(t,o),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},Xe(t)}function Xe(t){requestAnimationFrame(()=>{var e;const n=t.draggable.current;if(!n)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(n.orig)&&(t.animation.current=void 0);const i=t.pieces.get(n.orig);if(!i||!qe(i,n.piece))Ee(t);else if(!n.started&&he(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const r=n.element();if(!r)return;r.cgDragging=!0,r.classList.add("dragging"),n.element=r}const o=t.dom.bounds();z(n.element,[n.pos[0]-o.left-o.width/16,n.pos[1]-o.top-o.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==se(n.pos,q(t),o))}Xe(t)})}function Rn(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=re(e))}function Dn(t,e){const n=t.draggable.current;if(!n)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&n.originTarget!==e.target&&!n.newPiece){t.draggable.current=void 0;return}Y(t),X(t);const i=re(e)||n.pos,o=se(i,q(t),t.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?St(t,n.orig,o,n.force):(t.stats.ctrlKey=e.ctrlKey,Ct(t,n.orig,o)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!o&&(t.pieces.delete(n.orig),O(t.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===o||!o)?$(t):t.selectable.enabled||$(t),Ot(t),t.draggable.current=void 0,t.dom.redraw()}function Ee(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,$(t),Ot(t),t.dom.redraw())}function Ot(t){const e=t.dom.elements;e.ghost&&je(e.ghost,!1)}function qt(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&n.tagName==="PIECE")return n;n=n.nextSibling}}function On(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{tt(t,2),setTimeout(()=>tt(t,void 0),120)},120)}function tt(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function qn(t,e){function n(){on(t),e()}return{set(i){i.orientation&&i.orientation!==t.orientation&&n(),At(t,i),(i.fen?ne:V)(o=>Lt(o,i),t)},state:t,getFen:()=>_n(t.pieces),toggleOrientation:n,setPieces(i){ne(o=>rn(o,i),t)},selectSquare(i,o){i?ne(r=>Fe(r,i,o),t):t.selected&&($(t),t.dom.redraw())},move(i,o){ne(r=>kt(r,i,o),t)},newPiece(i,o){ne(r=>Ge(r,i,o),t)},playPremove(){if(t.premovable.current){if(ne(pn,t))return!0;t.dom.redraw()}return!1},playPredrop(i){if(t.predroppable.current){const o=gn(t,i);return t.dom.redraw(),o}return!1},cancelPremove(){V(Y,t)},cancelPredrop(){V(X,t)},cancelMove(){V(i=>{Ze(i),Ee(i)},t)},stop(){V(i=>{Je(i),Ee(i)},t)},explode(i){On(t,i)},setAutoShapes(i){V(o=>o.drawable.autoShapes=i,t)},setShapes(i){V(o=>o.drawable.shapes=i,t)},getKeyAtDomPos(i){return se(i,q(t),t.dom.bounds())},redrawAll:e,dragNewPiece(i,o,r){Nn(t,i,o,r)},destroy(){Je(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function Fn(){return{pieces:It(xt),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Jt()}}const nt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Bn(){const t=I("defs"),e=R(I("filter"),{id:"cg-filter-blur"});return e.appendChild(R(I("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function $n(t,e,n){var i;const o=t.drawable,r=o.current,s=r&&r.mouseSq?r:void 0,a=new Map,l=t.dom.bounds(),c=o.autoShapes.filter(m=>!m.piece);for(const m of o.shapes.concat(c).concat(s?[s]:[])){if(!m.dest)continue;const f=(i=a.get(m.dest))!==null&&i!==void 0?i:new Set,g=Pe(Se(S(m.orig),t.orientation),l),y=Pe(Se(S(m.dest),t.orientation),l);f.add($e(g,y)),a.set(m.dest,f)}const u=o.shapes.concat(c).map(m=>({shape:m,current:!1,hash:it(m,Be(m.dest,a),!1,l)}));s&&u.push({shape:s,current:!0,hash:it(s,Be(s.dest,a),!0,l)});const d=u.map(m=>m.hash).join(";");if(d===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=d;const h=e.querySelector("defs");Kn(o,u,h),Hn(u,e.querySelector("g"),n.querySelector("g"),m=>Un(t,m,o.brushes,a,l))}function Kn(t,e,n){var i;const o=new Map;let r;for(const l of e.filter(c=>c.shape.dest&&c.shape.brush))r=Ft(t.brushes[l.shape.brush],l.shape.modifiers),!((i=l.shape.modifiers)===null||i===void 0)&&i.hilite&&o.set(Ce(r).key,Ce(r)),o.set(r.key,r);const s=new Set;let a=n.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[l,c]of o.entries())s.has(l)||n.appendChild(Qn(c))}function Hn(t,e,n,i){const o=new Map;for(const r of t)o.set(r.hash,!1);for(const r of[e,n]){const s=[];let a=r.firstElementChild,l;for(;a;)l=a.getAttribute("cgHash"),o.has(l)?o.set(l,!0):s.push(a),a=a.nextElementSibling;for(const c of s)r.removeChild(c)}for(const r of t.filter(s=>!o.get(s.hash)))for(const s of i(r))s.isCustom?n.appendChild(s.el):e.appendChild(s.el)}function it({orig:t,dest:e,brush:n,piece:i,modifiers:o,customSvg:r,label:s},a,l,c){var u,d;return[c.width,c.height,l,t,e,n,a&&"-",i&&zn(i),o&&Wn(o),r&&`custom-${ot(r.html)},${(d=(u=r.center)===null||u===void 0?void 0:u[0])!==null&&d!==void 0?d:"o"}`,s&&`label-${ot(s.text)}`].filter(h=>h).join(",")}function zn(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function Wn(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function ot(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return e.toString()}function Un(t,{shape:e,current:n,hash:i},o,r,s){var a,l;const c=Pe(Se(S(e.orig),t.orientation),s),u=e.dest?Pe(Se(S(e.dest),t.orientation),s):c,d=e.brush&&Ft(o[e.brush],e.modifiers),h=r.get(e.dest),m=[];if(d){const f=R(I("g"),{cgHash:i});m.push({el:f}),c[0]!==u[0]||c[1]!==u[1]?f.appendChild(Gn(e,d,c,u,n,Be(e.dest,r))):f.appendChild(jn(o[e.brush],c,n,s))}if(e.label){const f=e.label;(a=f.fill)!==null&&a!==void 0||(f.fill=e.brush&&o[e.brush].color);const g=e.brush?void 0:"tr";m.push({el:Vn(f,i,c,u,h,g),isCustom:!0})}if(e.customSvg){const f=(l=e.customSvg.center)!==null&&l!==void 0?l:"orig",[g,y]=f==="label"?$t(c,u,h).map(P=>P-.5):f==="dest"?u:c,k=R(I("g"),{transform:`translate(${g},${y})`,cgHash:i});k.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,m.push({el:k,isCustom:!0})}return m}function jn(t,e,n,i){const o=Zn(),r=(i.width+i.height)/(4*Math.max(i.width,i.height));return R(I("circle"),{stroke:t.color,"stroke-width":o[n?0:1],fill:"none",opacity:Bt(t,n),cx:e[0],cy:e[1],r:r-o[1]/2})}function Ce(t){return["#ffffff","#fff","white"].includes(t.color)?nt.hilitePrimary:nt.hiliteWhite}function Gn(t,e,n,i,o,r){var s;function a(u){var d;const h=Xn(r&&!o),m=i[0]-n[0],f=i[1]-n[1],g=Math.atan2(f,m),y=Math.cos(g)*h,k=Math.sin(g)*h;return R(I("line"),{stroke:u?Ce(e).color:e.color,"stroke-width":Yn(e,o)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?Ce(e).key:e.key})`,opacity:!((d=t.modifiers)===null||d===void 0)&&d.hilite?1:Bt(e,o),x1:n[0],y1:n[1],x2:i[0]-y,y2:i[1]-k})}if(!(!((s=t.modifiers)===null||s===void 0)&&s.hilite))return a(!1);const l=I("g"),c=R(I("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(Jn(n,i)),c.appendChild(a(!0)),l.appendChild(c),l.appendChild(a(!1)),l}function Qn(t){const e=R(I("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(R(I("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function Vn(t,e,n,i,o,r){var s;const l=.4*.75**t.text.length,c=$t(n,i,o),u=r==="tr"?.4:0,d=R(I("g"),{transform:`translate(${c[0]+u},${c[1]-u})`,cgHash:e});d.appendChild(R(I("circle"),{r:.4/2,"fill-opacity":r?1:.8,"stroke-opacity":r?1:.7,"stroke-width":.03,fill:(s=t.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const h=R(I("text"),{"font-size":l,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return h.innerHTML=t.text,d.appendChild(h),d}function Se(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function Be(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function I(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function R(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.setAttribute(n,e[n]);return t}function Ft(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(n=>n).join("")}:t}function Zn(){return[3/64,4/64]}function Yn(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Bt(t,e){return(t.opacity||1)*(e?.9:1)}function Xn(t){return(t?20:10)/64}function Pe(t,e){const n=Math.min(1,e.width/e.height),i=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*i]}function Jn(t,e){const n={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return R(I("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function $e(t,e,n=!0){const i=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function ei(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((n,i)=>n+i*i,0))}function $t(t,e,n){let i=ei(t,e);const o=$e(t,e,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const r=$e(t,e);(n.has((r+1)%16)||n.has((r+15)%16))&&r&1&&(i-=.4)}return[t[0]-Math.cos(o)*i,t[1]-Math.sin(o)*i].map(r=>r+.5)}function ti(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const l of Zt)t.classList.toggle("orientation-"+l,e.orientation===l);t.classList.toggle("manipulable",!e.viewOnly);const n=U("cg-container");t.appendChild(n);const i=U("cg-board");n.appendChild(i);let o,r,s;if(e.drawable.visible&&(o=R(I("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(Bn()),o.appendChild(I("g")),r=R(I("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(I("g")),s=U("cg-auto-pieces"),n.appendChild(o),n.appendChild(r),n.appendChild(s)),e.coordinates){const l=e.orientation==="black"?" black":"",c=e.ranksPosition==="left"?" left":"";if(e.coordinatesOnSquares){const u=e.orientation==="white"?d=>d+1:d=>8-d;ye.forEach((d,h)=>n.appendChild(Ae(ke.map(m=>d+m),"squares rank"+u(h)+l+c)))}else n.appendChild(Ae(ke,"ranks"+l+c)),n.appendChild(Ae(ye,"files"+l))}let a;return e.draggable.enabled&&e.draggable.showGhost&&(a=U("piece","ghost"),je(a,!1),n.appendChild(a)),{board:i,container:n,wrap:t,ghost:a,svg:o,customSvg:r,autoPieces:s}}function Ae(t,e){const n=U("coords",e);let i;for(const o of t)i=U("coord"),i.textContent=o,n.appendChild(i);return n}function ni(t,e){if(!t.dropmode.active)return;Y(t),X(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const i=re(e),o=i&&se(i,q(t),t.dom.bounds());o&&St(t,"a0",o)}t.dom.redraw()}function ii(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",o=>o.preventDefault()),t.viewOnly)return;const i=ri(t);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function oi(t,e){const n=[];if("ResizeObserver"in window||n.push(ae(document.body,"chessground.resize",e)),!t.viewOnly){const i=rt(t,Rn,Pn),o=rt(t,Dn,Mn);for(const s of["touchmove","mousemove"])n.push(ae(document,s,i));for(const s of["touchend","mouseup"])n.push(ae(document,s,o));const r=()=>t.dom.bounds.clear();n.push(ae(document,"scroll",r,{capture:!0,passive:!0})),n.push(ae(window,"resize",r,{passive:!0}))}return()=>n.forEach(i=>i())}function ae(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}const ri=t=>e=>{t.draggable.current?Ee(t):t.drawable.current?Rt(t):e.shiftKey||gt(e)?t.drawable.enabled&&Sn(t,e):t.viewOnly||(t.dropmode.active?ni(t,e):Ln(t,e))},rt=(t,e,n)=>i=>{t.drawable.current?t.drawable.enabled&&n(t,i):t.viewOnly||e(t,i)};function si(t){const e=q(t),n=pe(t.dom.bounds()),i=t.dom.elements.board,o=t.pieces,r=t.animation.current,s=r?r.plan.anims:new Map,a=r?r.plan.fadings:new Map,l=t.draggable.current,c=li(t),u=new Set,d=new Set,h=new Map,m=new Map;let f,g,y,k,P,_,L,M,J,ee;for(g=i.firstChild;g;){if(f=g.cgKey,Kt(g))if(y=o.get(f),P=s.get(f),_=a.get(f),k=g.cgPiece,g.cgDragging&&(!l||l.orig!==f)&&(g.classList.remove("dragging"),z(g,n(S(f),e)),g.cgDragging=!1),!_&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),y){if(P&&g.cgAnimating&&k===le(y)){const E=S(f);E[0]+=P[2],E[1]+=P[3],g.classList.add("anim"),z(g,n(E,e))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),z(g,n(S(f),e)),t.addPieceZIndex&&(g.style.zIndex=Le(S(f),e)));k===le(y)&&(!_||!g.cgFading)?u.add(f):_&&k===le(_)?(g.classList.add("fading"),g.cgFading=!0):Te(h,k,g)}else Te(h,k,g);else if(Ht(g)){const E=g.className;c.get(f)===E?d.add(f):Te(m,E,g)}g=g.nextSibling}for(const[E,j]of c)if(!d.has(E)){J=m.get(j),ee=J&&J.pop();const K=n(S(E),e);if(ee)ee.cgKey=E,z(ee,K);else{const H=U("square",j);H.cgKey=E,z(H,K),i.insertBefore(H,i.firstChild)}}for(const[E,j]of o)if(P=s.get(E),!u.has(E))if(L=h.get(le(j)),M=L&&L.pop(),M){M.cgKey=E,M.cgFading&&(M.classList.remove("fading"),M.cgFading=!1);const K=S(E);t.addPieceZIndex&&(M.style.zIndex=Le(K,e)),P&&(M.cgAnimating=!0,M.classList.add("anim"),K[0]+=P[2],K[1]+=P[3]),z(M,n(K,e))}else{const K=le(j),H=U("piece",K),me=S(E);H.cgPiece=K,H.cgKey=E,P&&(H.cgAnimating=!0,me[0]+=P[2],me[1]+=P[3]),z(H,n(me,e)),t.addPieceZIndex&&(H.style.zIndex=Le(me,e)),i.appendChild(H)}for(const E of h.values())at(t,E);for(const E of m.values())at(t,E)}function ai(t){const e=q(t),n=pe(t.dom.bounds());let i=t.dom.elements.board.firstChild;for(;i;)(Kt(i)&&!i.cgAnimating||Ht(i))&&z(i,n(S(i.cgKey),e)),i=i.nextSibling}function st(t){var e,n;const i=t.dom.elements.wrap.getBoundingClientRect(),o=t.dom.elements.container,r=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*r;o.style.width=s+"px",o.style.height=a+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("---cg-width",s+"px"),(n=t.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",a+"px")}const Kt=t=>t.tagName==="PIECE",Ht=t=>t.tagName==="SQUARE";function at(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function Le(t,e){const i=t[1];return`${e?10-i:3+i}`}const le=t=>`${t.color} ${t.role}`;function li(t){var e,n,i;const o=new Map;if(t.lastMove&&t.highlight.lastMove)for(const a of t.lastMove)W(o,a,"last-move");if(t.check&&t.highlight.check&&W(o,t.check,"check"),t.selected&&(W(o,t.selected,"selected"),t.movable.showDests)){const a=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(a)for(const c of a)W(o,c,"move-dest"+(t.pieces.has(c)?" oc":""));const l=(i=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(t.selected))!==null&&i!==void 0?i:t.premovable.dests;if(l)for(const c of l)W(o,c,"premove-dest"+(t.pieces.has(c)?" oc":""))}const r=t.premovable.current;if(r)for(const a of r)W(o,a,"current-premove");else t.predroppable.current&&W(o,t.predroppable.current.key,"current-premove");const s=t.exploding;if(s)for(const a of s.keys)W(o,a,"exploding"+s.stage);return t.highlight.custom&&t.highlight.custom.forEach((a,l)=>{W(o,l,a)}),o}function W(t,e,n){const i=t.get(e);i?t.set(e,`${i} ${n}`):t.set(e,n)}function Te(t,e,n){const i=t.get(e);i?i.push(n):t.set(e,[n])}function ci(t,e,n){const i=new Map,o=[];for(const a of t)i.set(a.hash,!1);let r=e.firstElementChild,s;for(;r;)s=r.getAttribute("cgHash"),i.has(s)?i.set(s,!0):o.push(r),r=r.nextElementSibling;for(const a of o)e.removeChild(a);for(const a of t)i.get(a.hash)||e.appendChild(n(a))}function ui(t,e){const i=t.drawable.autoShapes.filter(o=>o.piece).map(o=>({shape:o,hash:fi(o),current:!1}));ci(i,e,o=>hi(t,o,t.dom.bounds()))}function di(t){var e;const n=q(t),i=pe(t.dom.bounds());let o=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;o;)pt(o,i(S(o.cgKey),n),o.cgScale),o=o.nextSibling}function hi(t,{shape:e,hash:n},i){var o,r,s;const a=e.orig,l=(o=e.piece)===null||o===void 0?void 0:o.role,c=(r=e.piece)===null||r===void 0?void 0:r.color,u=(s=e.piece)===null||s===void 0?void 0:s.scale,d=U("piece",`${l} ${c}`);return d.setAttribute("cgHash",n),d.cgKey=a,d.cgScale=u,pt(d,pe(i)(S(a),q(t)),u),d}const fi=t=>{var e,n,i;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(n=t.piece)===null||n===void 0?void 0:n.color,(i=t.piece)===null||i===void 0?void 0:i.scale].join(",")};function pi(t,e){const n=Fn();Lt(n,e||{});function i(){const o="dom"in n?n.dom.unbind:void 0,r=ti(t,n),s=Xt(()=>r.board.getBoundingClientRect()),a=u=>{si(c),r.autoPieces&&ui(c,r.autoPieces),!u&&r.svg&&$n(c,r.svg,r.customSvg)},l=()=>{st(c),ai(c),r.autoPieces&&di(c)},c=n;return c.dom={elements:r,bounds:s,redraw:gi(a),redrawNow:a,unbind:o},c.drawable.prevSvgHash="",st(c),a(!1),ii(c,l),o||(c.dom.unbind=oi(c,l)),c.events.insert&&c.events.insert(r),c}return qn(i(),i)}function gi(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const T="w",F="b",A="p",Ke="n",_e="b",ue="r",Z="q",x="k",Ne="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ve{constructor(e,n){C(this,"color");C(this,"from");C(this,"to");C(this,"piece");C(this,"captured");C(this,"promotion");C(this,"flags");C(this,"san");C(this,"lan");C(this,"before");C(this,"after");const{color:i,piece:o,from:r,to:s,flags:a,captured:l,promotion:c}=n,u=N(r),d=N(s);this.color=i,this.piece=o,this.from=u,this.to=d,this.san=e._moveToSan(n,e._moves({legal:!0})),this.lan=u+d,this.before=e.fen(),e._makeMove(n),this.after=e.fen(),e._undoMove(),this.flags="";for(const h in w)w[h]&a&&(this.flags+=te[h]);l&&(this.captured=l),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(te.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(te.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(te.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(te.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(te.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(te.BIG_PAWN)>-1}}const D=-1,te={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},w={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},b={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Re={b:[16,32,17,15],w:[-16,-32,-17,-15]},lt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},mi=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],vi=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],bi={p:1,n:2,b:4,r:8,q:16,k:32},_i="pnbrqkPNBRQK",ct=[Ke,_e,ue,Z],wi=7,yi=6,ki=1,Ei=0,be={[x]:w.KSIDE_CASTLE,[Z]:w.QSIDE_CASTLE},G={w:[{square:b.a1,flag:w.QSIDE_CASTLE},{square:b.h1,flag:w.KSIDE_CASTLE}],b:[{square:b.a8,flag:w.QSIDE_CASTLE},{square:b.h8,flag:w.KSIDE_CASTLE}]},Ci={b:ki,w:yi},Si=["1-0","0-1","1/2-1/2","*"];function ie(t){return t>>4}function fe(t){return t&15}function zt(t){return"0123456789".indexOf(t)!==-1}function N(t){const e=fe(t),n=ie(t);return"abcdefgh".substring(e,e+1)+"87654321".substring(n,n+1)}function ce(t){return t===T?F:T}function Pi(t){const e=t.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(e[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(e[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const o=e[0].split("/");if(o.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<o.length;s++){let a=0,l=!1;for(let c=0;c<o[s].length;c++)if(zt(o[s][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(o[s][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(o[s][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,l=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:s,regex:a}of r){if(!a.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((e[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(o[0]+o[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Mi(t,e){const n=t.from,i=t.to,o=t.piece;let r=0,s=0,a=0;for(let l=0,c=e.length;l<c;l++){const u=e[l].from,d=e[l].to,h=e[l].piece;o===h&&n!==u&&i===d&&(r++,ie(n)===ie(u)&&s++,fe(n)===fe(u)&&a++)}return r>0?s>0&&a>0?N(n):a>0?N(n).charAt(1):N(n).charAt(0):""}function Q(t,e,n,i,o,r=void 0,s=w.NORMAL){const a=ie(i);if(o===A&&(a===wi||a===Ei))for(let l=0;l<ct.length;l++){const c=ct[l];t.push({color:e,from:n,to:i,piece:o,captured:r,promotion:c,flags:s|w.PROMOTION})}else t.push({color:e,from:n,to:i,piece:o,captured:r,flags:s})}function ut(t){let e=t.charAt(0);return e>="a"&&e<="h"?t.match(/[a-h]\d.*[a-h]\d/)?void 0:A:(e=e.toLowerCase(),e==="o"?x:e)}function De(t){return t.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Oe(t){return t.split(" ").slice(0,4).join(" ")}class de{constructor(e=Ne,{skipValidation:n=!1}={}){C(this,"_board",new Array(128));C(this,"_turn",T);C(this,"_header",{});C(this,"_kings",{w:D,b:D});C(this,"_epSquare",-1);C(this,"_halfMoves",0);C(this,"_moveNumber",0);C(this,"_history",[]);C(this,"_comments",{});C(this,"_castling",{w:0,b:0});C(this,"_positionCount",{});this.load(e,{skipValidation:n})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:D,b:D},this._turn=T,this._castling={w:0,b:0},this._epSquare=D,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(e,{skipValidation:n=!1,preserveHeaders:i=!1}={}){let o=e.split(/\s+/);if(o.length>=2&&o.length<6){const a=["-","-","0","1"];e=o.concat(a.slice(-(6-o.length))).join(" ")}if(o=e.split(/\s+/),!n){const{ok:a,error:l}=Pi(e);if(!a)throw new Error(l)}const r=o[0];let s=0;this.clear({preserveHeaders:i});for(let a=0;a<r.length;a++){const l=r.charAt(a);if(l==="/")s+=8;else if(zt(l))s+=parseInt(l,10);else{const c=l<"a"?T:F;this._put({type:l.toLowerCase(),color:c},N(s)),s++}}this._turn=o[1],o[2].indexOf("K")>-1&&(this._castling.w|=w.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(this._castling.w|=w.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(this._castling.b|=w.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(this._castling.b|=w.QSIDE_CASTLE),this._epSquare=o[3]==="-"?D:b[o[3]],this._halfMoves=parseInt(o[4],10),this._moveNumber=parseInt(o[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){var r,s;let e=0,n="";for(let a=b.a8;a<=b.h1;a++){if(this._board[a]){e>0&&(n+=e,e=0);const{color:l,type:c}=this._board[a];n+=l===T?c.toUpperCase():c.toLowerCase()}else e++;a+1&136&&(e>0&&(n+=e),a!==b.h1&&(n+="/"),e=0,a+=8)}let i="";this._castling[T]&w.KSIDE_CASTLE&&(i+="K"),this._castling[T]&w.QSIDE_CASTLE&&(i+="Q"),this._castling[F]&w.KSIDE_CASTLE&&(i+="k"),this._castling[F]&w.QSIDE_CASTLE&&(i+="q"),i=i||"-";let o="-";if(this._epSquare!==D){const a=this._epSquare+(this._turn===T?16:-16),l=[a+1,a-1];for(const c of l){if(c&136)continue;const u=this._turn;if(((r=this._board[c])==null?void 0:r.color)===u&&((s=this._board[c])==null?void 0:s.type)===A){this._makeMove({color:u,from:c,to:this._epSquare,piece:A,captured:A,flags:w.EP_CAPTURE});const d=!this._isKingAttacked(u);if(this._undoMove(),d){o=N(this._epSquare);break}}}}return[n,this._turn,i,o,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==Ne?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(Ne)}get(e){return this._board[b[e]]}put({type:e,color:n},i){return this._put({type:e,color:n},i)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:n},i){if(_i.indexOf(e.toLowerCase())===-1||!(i in b))return!1;const o=b[i];if(e==x&&!(this._kings[n]==D||this._kings[n]==o))return!1;const r=this._board[o];return r&&r.type===x&&(this._kings[r.color]=D),this._board[o]={type:e,color:n},e===x&&(this._kings[n]=o),!0}remove(e){const n=this.get(e);return delete this._board[b[e]],n&&n.type===x&&(this._kings[n.color]=D),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),n}_updateCastlingRights(){var i,o,r,s,a,l,c,u,d,h,m,f;const e=((i=this._board[b.e1])==null?void 0:i.type)===x&&((o=this._board[b.e1])==null?void 0:o.color)===T,n=((r=this._board[b.e8])==null?void 0:r.type)===x&&((s=this._board[b.e8])==null?void 0:s.color)===F;(!e||((a=this._board[b.a1])==null?void 0:a.type)!==ue||((l=this._board[b.a1])==null?void 0:l.color)!==T)&&(this._castling.w&=-65),(!e||((c=this._board[b.h1])==null?void 0:c.type)!==ue||((u=this._board[b.h1])==null?void 0:u.color)!==T)&&(this._castling.w&=-33),(!n||((d=this._board[b.a8])==null?void 0:d.type)!==ue||((h=this._board[b.a8])==null?void 0:h.color)!==F)&&(this._castling.b&=-65),(!n||((m=this._board[b.h8])==null?void 0:m.type)!==ue||((f=this._board[b.h8])==null?void 0:f.color)!==F)&&(this._castling.b&=-33)}_updateEnPassantSquare(){var r,s;if(this._epSquare===D)return;const e=this._epSquare+(this._turn===T?-16:16),n=this._epSquare+(this._turn===T?16:-16),i=[n+1,n-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((r=this._board[n])==null?void 0:r.color)!==ce(this._turn)||((s=this._board[n])==null?void 0:s.type)!==A){this._epSquare=D;return}const o=a=>{var l,c;return!(a&136)&&((l=this._board[a])==null?void 0:l.color)===this._turn&&((c=this._board[a])==null?void 0:c.type)===A};i.some(o)||(this._epSquare=D)}_attacked(e,n,i){const o=[];for(let r=b.a8;r<=b.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;const s=this._board[r],a=r-n;if(a===0)continue;const l=a+119;if(mi[l]&bi[s.type]){if(s.type===A){if(a>0&&s.color===T||a<=0&&s.color===F)if(i)o.push(N(r));else return!0;continue}if(s.type==="n"||s.type==="k")if(i){o.push(N(r));continue}else return!0;const c=vi[l];let u=r+c,d=!1;for(;u!==n;){if(this._board[u]!=null){d=!0;break}u+=c}if(!d)if(i){o.push(N(r));continue}else return!0}}return i?o:!1}attackers(e,n){return n?this._attacked(n,b[e],!0):this._attacked(this._turn,b[e],!0)}_isKingAttacked(e){const n=this._kings[e];return n===-1?!1:this._attacked(ce(e),n)}isAttacked(e,n){return this._attacked(n,b[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},n=[];let i=0,o=0;for(let r=b.a8;r<=b.h1;r++){if(o=(o+1)%2,r&136){r+=7;continue}const s=this._board[r];s&&(e[s.type]=s.type in e?e[s.type]+1:1,s.type===_e&&n.push(o),i++)}if(i===2)return!0;if(i===3&&(e[_e]===1||e[Ke]===1))return!0;if(i===e[_e]+2){let r=0;const s=n.length;for(let a=0;a<s;a++)r+=n[a];if(r===0||r===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:n=void 0,piece:i=void 0}={}){const o=this._moves({square:n,piece:i});return e?o.map(r=>new ve(this,r)):o.map(r=>this._moveToSan(r,o))}_moves({legal:e=!0,piece:n=void 0,square:i=void 0}={}){var m;const o=i?i.toLowerCase():void 0,r=n==null?void 0:n.toLowerCase(),s=[],a=this._turn,l=ce(a);let c=b.a8,u=b.h1,d=!1;if(o)if(o in b)c=u=b[o],d=!0;else return[];for(let f=c;f<=u;f++){if(f&136){f+=7;continue}if(!this._board[f]||this._board[f].color===l)continue;const{type:g}=this._board[f];let y;if(g===A){if(r&&r!==g)continue;y=f+Re[a][0],this._board[y]||(Q(s,a,f,y,A),y=f+Re[a][1],Ci[a]===ie(f)&&!this._board[y]&&Q(s,a,f,y,A,void 0,w.BIG_PAWN));for(let k=2;k<4;k++)y=f+Re[a][k],!(y&136)&&(((m=this._board[y])==null?void 0:m.color)===l?Q(s,a,f,y,A,this._board[y].type,w.CAPTURE):y===this._epSquare&&Q(s,a,f,y,A,A,w.EP_CAPTURE))}else{if(r&&r!==g)continue;for(let k=0,P=lt[g].length;k<P;k++){const _=lt[g][k];for(y=f;y+=_,!(y&136);){if(!this._board[y])Q(s,a,f,y,g);else{if(this._board[y].color===a)break;Q(s,a,f,y,g,this._board[y].type,w.CAPTURE);break}if(g===Ke||g===x)break}}}}if((r===void 0||r===x)&&(!d||u===this._kings[a])){if(this._castling[a]&w.KSIDE_CASTLE){const f=this._kings[a],g=f+2;!this._board[f+1]&&!this._board[g]&&!this._attacked(l,this._kings[a])&&!this._attacked(l,f+1)&&!this._attacked(l,g)&&Q(s,a,this._kings[a],g,x,void 0,w.KSIDE_CASTLE)}if(this._castling[a]&w.QSIDE_CASTLE){const f=this._kings[a],g=f-2;!this._board[f-1]&&!this._board[f-2]&&!this._board[f-3]&&!this._attacked(l,this._kings[a])&&!this._attacked(l,f-1)&&!this._attacked(l,g)&&Q(s,a,this._kings[a],g,x,void 0,w.QSIDE_CASTLE)}}if(!e||this._kings[a]===-1)return s;const h=[];for(let f=0,g=s.length;f<g;f++)this._makeMove(s[f]),this._isKingAttacked(a)||h.push(s[f]),this._undoMove();return h}move(e,{strict:n=!1}={}){let i=null;if(typeof e=="string")i=this._moveFromSan(e,n);else if(typeof e=="object"){const r=this._moves();for(let s=0,a=r.length;s<a;s++)if(e.from===N(r[s].from)&&e.to===N(r[s].to)&&(!("promotion"in r[s])||e.promotion===r[s].promotion)){i=r[s];break}}if(!i)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const o=new ve(this,i);return this._makeMove(i),this._incPositionCount(o.after),o}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const n=this._turn,i=ce(n);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&w.EP_CAPTURE&&(this._turn===F?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:n}),this._board[e.to].type===x){if(this._kings[n]=e.to,e.flags&w.KSIDE_CASTLE){const o=e.to-1,r=e.to+1;this._board[o]=this._board[r],delete this._board[r]}else if(e.flags&w.QSIDE_CASTLE){const o=e.to+1,r=e.to-2;this._board[o]=this._board[r],delete this._board[r]}this._castling[n]=0}if(this._castling[n]){for(let o=0,r=G[n].length;o<r;o++)if(e.from===G[n][o].square&&this._castling[n]&G[n][o].flag){this._castling[n]^=G[n][o].flag;break}}if(this._castling[i]){for(let o=0,r=G[i].length;o<r;o++)if(e.to===G[i][o].square&&this._castling[i]&G[i][o].flag){this._castling[i]^=G[i][o].flag;break}}e.flags&w.BIG_PAWN?n===F?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=D,e.piece===A?this._halfMoves=0:e.flags&(w.CAPTURE|w.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,n===F&&this._moveNumber++,this._turn=i}undo(){const e=this._undoMove();if(e){const n=new ve(this,e);return this._decPositionCount(n.after),n}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const n=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const i=this._turn,o=ce(i);if(this._board[n.from]=this._board[n.to],this._board[n.from].type=n.piece,delete this._board[n.to],n.captured)if(n.flags&w.EP_CAPTURE){let r;i===F?r=n.to-16:r=n.to+16,this._board[r]={type:A,color:o}}else this._board[n.to]={type:n.captured,color:o};if(n.flags&(w.KSIDE_CASTLE|w.QSIDE_CASTLE)){let r,s;n.flags&w.KSIDE_CASTLE?(r=n.to+1,s=n.to-1):(r=n.to-2,s=n.to+1),this._board[r]=this._board[s],delete this._board[s]}return n}pgn({newline:e=`
`,maxWidth:n=0}={}){const i=[];let o=!1;for(const h in this._header)i.push("["+h+' "'+this._header[h]+'"]'+e),o=!0;o&&this._history.length&&i.push(e);const r=h=>{const m=this._comments[this.fen()];if(typeof m<"u"){const f=h.length>0?" ":"";h=`${h}${f}{${m}}`}return h},s=[];for(;this._history.length>0;)s.push(this._undoMove());const a=[];let l="";for(s.length===0&&a.push(r(""));s.length>0;){l=r(l);const h=s.pop();if(!h)break;if(!this._history.length&&h.color==="b"){const m=`${this._moveNumber}. ...`;l=l?`${l} ${m}`:m}else h.color==="w"&&(l.length&&a.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(h,this._moves({legal:!0})),this._makeMove(h)}if(l.length&&a.push(r(l)),typeof this._header.Result<"u"&&a.push(this._header.Result),n===0)return i.join("")+a.join(" ");const c=function(){return i.length>0&&i[i.length-1]===" "?(i.pop(),!0):!1},u=function(h,m){for(const f of m.split(" "))if(f){if(h+f.length>n){for(;c();)h--;i.push(e),h=0}i.push(f),h+=f.length,i.push(" "),h++}return c()&&h--,h};let d=0;for(let h=0;h<a.length;h++){if(d+a[h].length>n&&a[h].includes("{")){d=u(d,a[h]);continue}d+a[h].length>n&&h!==0?(i[i.length-1]===" "&&i.pop(),i.push(e),d=0):h!==0&&(i.push(" "),d++),i.push(a[h]),d+=a[h].length}return i.join("")}header(...e){for(let n=0;n<e.length;n+=2)typeof e[n]=="string"&&typeof e[n+1]=="string"&&(this._header[e[n]]=e[n+1]);return this._header}setHeader(e,n){return this._header[e]=n,this._header}removeHeader(e){return e in this._header?(delete this._header[e],!0):!1}getHeaders(){return this._header}loadPgn(e,{strict:n=!1,newlineChar:i=`\r?
`}={}){function o(_){return _.replace(/\\/g,"\\")}function r(_){const L={},M=_.split(new RegExp(o(i)));let J="",ee="";for(let E=0;E<M.length;E++){const j=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;J=M[E].replace(j,"$1"),ee=M[E].replace(j,"$2"),J.trim().length>0&&(L[J]=ee)}return L}e=e.trim();const a=new RegExp("^(\\[((?:"+o(i)+")|.)*\\])((?:\\s*"+o(i)+"){2}|(?:\\s*"+o(i)+")*$)").exec(e),l=a&&a.length>=2?a[1]:"";this.reset();const c=r(l);let u="";for(const _ in c)_.toLowerCase()==="fen"&&(u=c[_]),this.header(_,c[_]);if(!n)u&&this.load(u,{preserveHeaders:!0});else if(c.SetUp==="1"){if(!("FEN"in c))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(c.FEN,{preserveHeaders:!0})}function d(_){return Array.from(_).map(function(L){return L.charCodeAt(0)<128?L.charCodeAt(0).toString(16):encodeURIComponent(L).replace(/%/g,"").toLowerCase()}).join("")}function h(_){return _.length==0?"":decodeURIComponent("%"+(_.match(/.{1,2}/g)||[]).join("%"))}const m=function(_){return _=_.replace(new RegExp(o(i),"g")," "),`{${d(_.slice(1,_.length-1))}}`},f=function(_){if(_.startsWith("{")&&_.endsWith("}"))return h(_.slice(1,_.length-1))};let g=e.replace(l,"").replace(new RegExp(`({[^}]*})+?|;([^${o(i)}]*)`,"g"),function(_,L,M){return L!==void 0?m(L):" "+m(`{${M.slice(1)}}`)}).replace(new RegExp(o(i),"g")," ");const y=/(\([^()]+\))+?/g;for(;y.test(g);)g=g.replace(y,"");g=g.replace(/\d+\.(\.\.)?/g,""),g=g.replace(/\.\.\./g,""),g=g.replace(/\$\d+/g,"");let k=g.trim().split(new RegExp(/\s+/));k=k.filter(_=>_!=="");let P="";for(let _=0;_<k.length;_++){const L=f(k[_]);if(L!==void 0){this._comments[this.fen()]=L;continue}const M=this._moveFromSan(k[_],n);if(M==null)if(Si.indexOf(k[_])>-1)P=k[_];else throw new Error(`Invalid move in PGN: ${k[_]}`);else P="",this._makeMove(M),this._incPositionCount(this.fen())}P&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",P)}_moveToSan(e,n){let i="";if(e.flags&w.KSIDE_CASTLE)i="O-O";else if(e.flags&w.QSIDE_CASTLE)i="O-O-O";else{if(e.piece!==A){const o=Mi(e,n);i+=e.piece.toUpperCase()+o}e.flags&(w.CAPTURE|w.EP_CAPTURE)&&(e.piece===A&&(i+=N(e.from)[0]),i+="x"),i+=N(e.to),e.promotion&&(i+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(e,n=!1){const i=De(e);let o=ut(i),r=this._moves({legal:!0,piece:o});for(let h=0,m=r.length;h<m;h++)if(i===De(this._moveToSan(r[h],r)))return r[h];if(n)return null;let s,a,l,c,u,d=!1;if(a=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],l=a[2],c=a[3],u=a[4],l.length==1&&(d=!0)):(a=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],l=a[2],c=a[3],u=a[4],l.length==1&&(d=!0))),o=ut(i),r=this._moves({legal:!0,piece:s||o}),!c)return null;for(let h=0,m=r.length;h<m;h++)if(l){if((!s||s.toLowerCase()==r[h].piece)&&b[l]==r[h].from&&b[c]==r[h].to&&(!u||u.toLowerCase()==r[h].promotion))return r[h];if(d){const f=N(r[h].from);if((!s||s.toLowerCase()==r[h].piece)&&b[c]==r[h].to&&(l==f[0]||l==f[1])&&(!u||u.toLowerCase()==r[h].promotion))return r[h]}}else if(i===De(this._moveToSan(r[h],r)).replace("x",""))return r[h];return null}ascii(){let e=`   +------------------------+
`;for(let n=b.a8;n<=b.h1;n++){if(fe(n)===0&&(e+=" "+"87654321"[ie(n)]+" |"),this._board[n]){const i=this._board[n].type,r=this._board[n].color===T?i.toUpperCase():i.toLowerCase();e+=" "+r+" "}else e+=" . ";n+1&136&&(e+=`|
`,n+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const n=this._moves({legal:!1});let i=0;const o=this._turn;for(let r=0,s=n.length;r<s;r++)this._makeMove(n[r]),this._isKingAttacked(o)||(e-1>0?i+=this.perft(e-1):i++),this._undoMove();return i}turn(){return this._turn}board(){const e=[];let n=[];for(let i=b.a8;i<=b.h1;i++)this._board[i]==null?n.push(null):n.push({square:N(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(e.push(n),n=[],i+=8);return e}squareColor(e){if(e in b){const n=b[e];return(ie(n)+fe(n))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const n=[],i=[];for(;this._history.length>0;)n.push(this._undoMove());for(;;){const o=n.pop();if(!o)break;e?i.push(new ve(this,o)):i.push(this._moveToSan(o,this._moves())),this._makeMove(o)}return i}_getPositionCount(e){const n=Oe(e);return this._positionCount[n]||0}_incPositionCount(e){const n=Oe(e);this._positionCount[n]===void 0&&(this._positionCount[n]=0),this._positionCount[n]+=1}_decPositionCount(e){const n=Oe(e);this._positionCount[n]===1?delete this._positionCount[n]:this._positionCount[n]-=1}_pruneComments(){const e=[],n={},i=o=>{o in this._comments&&(n[o]=this._comments[o])};for(;this._history.length>0;)e.push(this._undoMove());for(i(this.fen());;){const o=e.pop();if(!o)break;this._makeMove(o),i(this.fen())}this._comments=n}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const n=this._comments[e];return delete this._comments[e],{fen:e,comment:n}})}setCastlingRights(e,n){for(const o of[x,Z])n[o]!==void 0&&(n[o]?this._castling[e]|=be[o]:this._castling[e]&=~be[o]);this._updateCastlingRights();const i=this.getCastlingRights(e);return(n[x]===void 0||n[x]===i[x])&&(n[Z]===void 0||n[Z]===i[Z])}getCastlingRights(e){return{[x]:(this._castling[e]&be[x])!==0,[Z]:(this._castling[e]&be[Z])!==0}}moveNumber(){return this._moveNumber}}class xi{constructor(e="/sf/stockfish-17-lite-02843c1.js"){this.engine=new Worker(e,{type:"module"}),this.isReady=!1,this.currentAnalysis=null,this.pendingResolve=null,this.lastEvaluations={},this.onEvaluationUpdate=null,this.analysisId=0,this._setupEngine(),this._setupListeners()}_setupEngine(){this._sendCommand("uci"),this._sendCommand("setoption name MultiPV value 3"),this._sendCommand("isready")}_setupListeners(){this.engine.onmessage=e=>{const i=e.data.split(`
`);for(const o of i){if(o.includes("readyok")&&(this.isReady=!0),this.currentAnalysis&&o.includes("info depth")&&o.includes("multipv")){const r=/multipv (\d+)/.exec(o),s=/depth (\d+)/.exec(o),a=/ pv (.+)$/.exec(o),l=/score cp ([-\d]+)/.exec(o),c=/score mate ([-\d]+)/.exec(o);if(r&&s&&a&&(l||c)){const u=parseInt(r[1]),d=parseInt(s[1]),h=a[1].split(" ");let m,f=!1;if(l)m=parseInt(l[1]),this.currentAnalysis.sideToMove==="b"&&(m=-m);else if(c){f=!0;const g=parseInt(c[1]);m=g>0?1e4-g*10:-1e4-g*10,this.currentAnalysis.sideToMove==="b"&&(m=-m)}if(this.lastEvaluations[u]={line:u,score:m,depth:d,moves:h,isMate:f,mateIn:f?c[1]:null,centipawnLoss:u===1?0:this.lastEvaluations[1]?Math.abs(this.lastEvaluations[1].score-m):0},this.onEvaluationUpdate){const g=Object.values(this.lastEvaluations);this.onEvaluationUpdate(g,this.currentAnalysis.id)}}}if(this.currentAnalysis&&o.includes("bestmove")){const r=Object.values(this.lastEvaluations);this.currentAnalysis.id,this.pendingResolve&&this.currentAnalysis&&(this.pendingResolve(r),this.pendingResolve=null),this.lastEvaluations={},this.currentAnalysis=null}}}}_sendCommand(e){this.engine.postMessage(e)}async waitForReady(){return this.isReady?Promise.resolve():new Promise(e=>{const n=setInterval(()=>{this.isReady&&(clearInterval(n),e())},100)})}async analyzePosition(e,n=25){await this.waitForReady(),await this._stopAnalysis(),this.lastEvaluations={};const i=++this.analysisId,o=e.split(" ")[1];return this.currentAnalysis={fen:e,depth:n,sideToMove:o,id:i},new Promise(r=>{this.pendingResolve=r,this._sendCommand("position fen "+e),this._sendCommand("go depth "+n)})}async _stopAnalysis(){if(this.currentAnalysis)return new Promise(e=>{this._sendCommand("stop");const n=setInterval(()=>{this.currentAnalysis||(clearInterval(n),e())},50);if(this.pendingResolve){const i=Object.values(this.lastEvaluations);this.pendingResolve(i),this.pendingResolve=null}this.currentAnalysis=null})}dispose(){this._stopAnalysis(),this._sendCommand("quit"),this.engine.terminate()}}const Ii=async(t,e,n)=>{const i=new Date,o=[];for(let r=0;r<n;r++){const s=i.getFullYear(),a=String(i.getMonth()+1).padStart(2,"0");o.push(`https://api.chess.com/pub/player/${t}/games/${s}/${a}`),i.setMonth(i.getMonth()-1)}try{const r=[];for(const s of o){const a=await fetch(s);if(!a.ok)continue;const l=await a.json();r.push(...l.games.filter(c=>c.white.username.toLowerCase()===t.toLowerCase()&&e==="white"||c.black.username.toLowerCase()===t.toLowerCase()&&e==="black"))}return r.map(s=>s.pgn)}catch(r){throw console.error("Error fetching Chess.com games:",r),r}},Ai=async(t,e,n)=>{const i=new Date;i.setMonth(i.getMonth()-n);const o=`https://lichess.org/api/games/user/${t}?max=500&pgnInJson=true`;try{const r=await fetch(o,{method:"GET",headers:{Accept:"application/x-ndjson"}});if(!r.ok)throw new Error("Failed to fetch data");return(await r.text()).split(`
`).filter(u=>u).map(u=>JSON.parse(u)).filter(u=>new Date(u.createdAt)>=i).filter(u=>e==="white"?u.players.white.user.id===t:e==="black"?u.players.black.user.id===t:!1).map(u=>u.pgn)}catch(r){throw console.error("Error fetching Lichess games:",r),r}},Li=(t,e,n,i)=>t==="chesscom"?Ii(e,n,i):Ai(e,n,i);class Ti{constructor(e="/sf/stockfish-17-lite-02843c1.js"){this.engine=new Worker(e,{type:"module"}),this.isReady=!1,this.pendingResolve=null,this.currentAnalysis=null,this._setupEngine(),this._setupListeners()}_setupEngine(){this._sendCommand("uci"),this._sendCommand("setoption name MultiPV value 1"),this._sendCommand("isready")}_setupListeners(){this.engine.onmessage=e=>{const i=e.data.split(`
`);for(const o of i){if(o.includes("readyok")&&(this.isReady=!0),this.currentAnalysis&&o.includes("info depth")&&o.includes("score cp")){const r=/score cp ([-\d]+)/.exec(o),s=/depth (\d+)/.exec(o),a=/ pv (.+)$/.exec(o);if(r&&s&&a){let l=parseInt(r[1]);const c=parseInt(s[1]),u=a[1].split(" ");this.currentAnalysis.sideToMove==="b"&&(l=-l),this.currentAnalysis.bestMove={score:l,depth:c,moves:u}}}if(this.currentAnalysis&&o.includes("bestmove")){const r=this.currentAnalysis.bestMove||null;this.pendingResolve&&(this.pendingResolve(r),this.pendingResolve=null),this.currentAnalysis=null}}}}_sendCommand(e){this.engine.postMessage(e)}async waitForReady(){if(!this.isReady)return new Promise(e=>{const n=setInterval(()=>{this.isReady&&(clearInterval(n),e())},100)})}async analyzePosition(e,n=20){return await this.waitForReady(),this.currentAnalysis={fen:e,depth:n,sideToMove:e.split(" ")[1]},new Promise(i=>{this.pendingResolve=i,this._sendCommand(`position fen ${e}`),this._sendCommand(`go depth ${n}`)})}dispose(){this._sendCommand("quit"),this.engine.terminate()}}async function Ni(t,e=18){const n=new Ti;try{return await n.analyzePosition(t,e)}finally{n.dispose()}}class dt{constructor(e,n,i){this.fen=e,this.evaluated=!1,this.count=n||0,this.parent=i||null,this.children=[],this.eval=0,this.move=null,this.whiteWins=0,this.blackWins=0,this.draws=0}}class Ri{constructor(e,n){this.pgns=e,this.color=n,this.fenNode=new Map,this.chess=new de,this.root=new dt("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",0),this.fenNode.set(this.root.fen,this.root),this.initialized=!1,this.evaluating=!1,this.initialize().then(()=>{this._startBackgroundEvaluation()})}async initialize(){return this.pgns=await Promise.resolve(this.pgns),await this._parsePGNs(),this.initialized=!0,this}async _parsePGNs(){const e=Array.isArray(this.pgns)?this.pgns:[];for(let n=0;n<e.length;n++)this._putPGN(e[n])}_putPGN(e,n){try{this.chess.loadPgn(e);const i=this.chess.history({verbose:!0}),o=n||this._extractResultFromPgn(e);this.chess.reset();let r=this.chess.fen();this.fenNode.has(r)||this.fenNode.set(r,this.root),this.fenNode.get(r).count++,this._updateResultCounts(this.root,o);let s=this.root;for(const a of i){this.chess.move(a),r=this.chess.fen();let l;this.fenNode.has(r)?(l=this.fenNode.get(r),l.count++):(l=new dt(r,1,s),l.move={from:a.from,to:a.to,promotion:a.promotion||null},this.fenNode.set(r,l)),this._updateResultCounts(l,o),s.children.some(c=>c.fen===r)||s.children.push(l),s=l}return this.chess.reset(),!0}catch(i){return console.error("Error processing PGN:",i),!1}}_getUciMoveFromFens(e,n){const i=new de(e),o=i.moves({verbose:!0});for(const r of o){if(i.move(r),i.fen()===n)return r;i.undo()}return null}getMovesForPosition(e){if(!this.initialized)return[];const n=this._normalizeFen(e);if(!this.fenNode.has(n))return[];const i=this.fenNode.get(n);return i.children.map(o=>{const r=this._getUciMoveFromFens(e,o.fen),s=new de(n),a=s.move(r);let l=!1;return i.evaluated&&o.evaluated&&Math.abs(o.score)-Math.abs(i.score)>.6&&(this.color==="white"&&o.score<i.score&&s.turn()==="b"||this.color==="black"&&o.score>i.score&&s.turn()==="w")&&(l=!0),{san:r.san,uci:`${r.from}${r.to}${r.promotion||""}`,count:o.count,fen:o.fen,evaluation:o.eval,winPercentage:this._calculateWinPercentage(o),whiteWins:o.whiteWins,blackWins:o.blackWins,draws:o.draws,isLegal:!!a,moveSuperScript:l?"??":""}}).filter(o=>o.isLegal).sort((o,r)=>r.count-o.count)}async evalTree(e=this.root.fen){this.initialized||await this.initialize();const n=this._normalizeFen(e);if(!this.fenNode.has(n))return[];this.chess=new de(n);const i=this.fenNode.get(n),o=[i];for(;o.length>0;){const r=o.shift();if(!r.evaluated)try{if(r.evaluated===!1){const s=await Ni(r.fen);r.eval=s.score/100,r.evaluated=!0,document.dispatchEvent(new CustomEvent("explorer-node-evaluated",{detail:{fen:r.fen}}))}for(let s of r.children)o.push(s)}catch(s){console.error("Error during tree evaluation:",s)}}return i}_extractResultFromPgn(e){return e.includes("1-0")?"1-0":e.includes("0-1")?"0-1":e.includes("1/2-1/2")?"1/2-1/2":null}_updateResultCounts(e,n){n==="1-0"?e.whiteWins++:n==="0-1"?e.blackWins++:n==="1/2-1/2"&&e.draws++}_calculateWinPercentage(e){return e.count===0?0:(this.color==="white"?e.whiteWins:e.blackWins)/e.count*100}_startBackgroundEvaluation(){this.evaluating||(this.evaluating=!0,setTimeout(async()=>{await this.evalTree(),this.evaluating=!1},0))}_normalizeFen(e){return e.trim()}}class Di{constructor(e,n,i,o,r){this.username=e,this.platform=n,this.color=i,this.startingPosition=o,this.currentPosition=o,this.months=r,this.container=document.getElementById("explorer-move-list"),this.tree=null,this.pgns=null,this.isInitialized=!1,this.isLoading=!1,this.children=[],document.addEventListener("explorer-node-evaluated",s=>{this.children.some(a=>a.fen===s.detail.fen)&&this.render()})}async initialize(){if(this.isInitialized)return this;this.isLoading=!0;try{return this.pgns=await this._fetchGames(),this.tree=new Ri(this.pgns,this.color),await this.tree.initialize(),this.isInitialized=!0,this.isLoading=!1,this}catch(e){throw this.isLoading=!1,console.error("Explorer initialization failed:",e),e}}async _fetchGames(){try{return await Li(this.platform,this.username,this.color,this.months)}catch(e){throw console.error("Failed to fetch games:",e),e}}async _evalTree(){if(!this.tree)throw new Error("Tree not initialized");await this.tree.evalTree(this.startingPosition)}getMovesForPosition(e=null){if(!this.isInitialized||!this.tree)return[];const n=e||this.currentPosition;return this.tree.getMovesForPosition(n)}updatePosition(e){return this.currentPosition=e,this._startBackgroundEval(),this.getMovesForPosition()}async _startBackgroundEval(){if(this.tree.fenNode.has(this.currentPosition)&&!this.tree.fenNode.get(this.currentPosition).evaluated){this.tree.evaluating=!0;try{await this.tree.evalTree(this.currentPosition)}catch(e){console.error("Background eval failed:",e)}finally{this.tree.evaluating=!1}}}async refresh(e,n,i,o){return e&&(this.username=e),n&&(this.platform=n),i&&(this.color=i),o&&(this.days=o),this.isInitialized=!1,await this.initialize()}render(){if(!this.container)return;if(this.container.innerHTML="",this.isLoading){this.container.innerHTML='<div class="loading">Loading explorer data...</div>';return}if(!this.isInitialized){this.container.innerHTML='<div class="not-initialized">Explorer not initialized</div>';return}const e=this.getMovesForPosition(this.currentPosition);if(this.children=e,e.length===0){this.container.innerHTML='<div class="no-moves">No games found for this position</div>';return}e.forEach((n,i)=>{const o=document.createElement("li");o.className=`explorer-move-${i%2}`,o.innerHTML=`
        <div style="width: 70px;">${n.san+n.moveSuperScript}</div>
        <div style="width: 50px;">${n.count}</div>
        <div style="width: 50px;">${Math.round(n.winPercentage)}%</div>
        <div style="width: 50px;">${(n.evaluation>=0?"+":"-")+Math.abs(n.evaluation).toFixed(2)}</div>
      `,o.addEventListener("click",()=>{const r=new CustomEvent("explorer-san-move-selected",{detail:{san:n.san,fen:n.fen}});document.dispatchEvent(r)}),this.container.appendChild(o)})}}const v={username:document.getElementById("username"),websiteOrigin:document.getElementById("websiteOrigin"),colorToggle:document.getElementById("colorToggle"),months:document.getElementById("months"),icon:document.getElementById("queenIcon"),searching:document.getElementById("startSearch"),board:document.getElementById("board"),resizeHandle:document.getElementById("resize-handle"),container:document.getElementById("container"),engineEvaluation:document.getElementById("evaluation-score"),engineDepth:document.getElementById("engine-depth"),lines:[document.getElementById("line1"),document.getElementById("line2"),document.getElementById("line3")],evalScores:[document.getElementById("score1"),document.getElementById("score2"),document.getElementById("score3")],evalLines:[document.getElementById("moves1"),document.getElementById("moves2"),document.getElementById("moves3")],explorerMoveList:document.getElementById("explorer-move-list"),settingsToggle:document.getElementById("settings"),settingsPopup:document.getElementById("settings-popup"),settingsFooter:document.getElementById("settings-footer"),depthSlider:document.getElementById("depth-slider"),depthValue:document.getElementById("size-value"),blueButton:document.getElementById("blue-button"),greenButton:document.getElementById("green-button"),brownButton:document.getElementById("brown-button")},p={userIsWhite:!0,engine:new xi,chess:new de,ground:null,explorer:null,moveHistory:[],currentMoveIndex:0,currentAnalysisId:0,maxDepth:30,lines:[],boardTheme:"brown"};async function Wt(t,e,n,i){try{v.explorerMoveList&&(v.explorerMoveList.innerHTML='<div class="loading">Loading explorer data...</div>');const o=p.chess.fen();p.explorer=new Di(t,e,n,o,i),await p.explorer.initialize(),p.explorer.render()}catch(o){console.error("Failed to initialize explorer:",o),v.explorerMoveList&&(v.explorerMoveList.innerHTML='<div class="error">Error loading explorer data</div>')}}function Ut(){p.explorer&&(p.explorer.updatePosition(p.chess.fen()),p.explorer.render())}p.engine.onEvaluationUpdate=(t,e)=>{if(e!==p.currentAnalysisId)return;let n=null,i=null,o=null;p.lines=t.map(r=>r.moves[0]),t.forEach(r=>{const s=r.line-1;if(s>=0&&s<3){const a=(r.score/100).toFixed(2),l=r.score>=0?"+":"";v.evalScores[s].innerText=`${l}${a}`,r.score>=0?v.evalScores[s].className="white-advantage":v.evalScores[s].className="black-advantage",n===null&&(o=l,n=a,i=r.depth);let c=r.moves.slice(0,10).join(" ");r.line>1&&r.centipawnLoss>0&&(c+=` (${r.centipawnLoss}cp)`),v.evalLines[s].innerText=c}}),v.engineEvaluation.innerText=`${o}${n}`,v.engineDepth.innerText=`(d=${i}/${p.maxDepth})`};function ht(){const t=window.innerWidth,e=window.innerHeight,n=Math.min(t*.7,e*.7);v.board.style.width=`${n}px`,v.board.style.height=`${n}px`,p.ground&&p.ground.redrawAll()}function Me(t){p.currentMoveIndex<p.moveHistory.length-1&&p.moveHistory.splice(p.currentMoveIndex+1),p.moveHistory.push({move:t,fen:p.chess.fen()}),p.currentMoveIndex=p.moveHistory.length-1}function Oi(t,e,n=void 0){const i=p.chess.move({from:t,to:e,promotion:n});return i?(Me(i),ge(),i):null}function jt(t){const e=p.chess.move(t);return e?(Me(e),ge(),e):null}function He(t){const e=p.chess.move(t);return e?(Me(e),ge(),e):null}function ze(t){if(t==="prev"&&p.currentMoveIndex>0)p.currentMoveIndex--;else if(t==="next"&&p.currentMoveIndex<p.moveHistory.length-1)p.currentMoveIndex++;else return;p.chess.load(p.moveHistory[p.currentMoveIndex].fen),xe(p.chess.fen(),p.maxDepth),Ut();const e=p.moveHistory[p.currentMoveIndex].move,n=e?[e.from,e.to]:void 0;p.ground.set({fen:p.chess.fen(),turnColor:p.chess.turn()==="w"?"white":"black",movable:{color:p.chess.turn()==="w"?"white":"black",dests:Gt(),free:!1},lastMove:n})}function Gt(){const t=new Map,e=p.chess;for(let n=0;n<8;n++)for(let i=0;i<8;i++){const o=String.fromCharCode(97+i),r=8-n,s=o+r;if(e.get(s)){const l=e.moves({square:s,verbose:!0});l.length>0&&t.set(s,l.map(c=>c.to))}}return t}function qi(){for(let t=0;t<3;t++)v.evalScores[t].innerText="...",v.evalLines[t].innerText="..."}async function xe(t,e=p.maxDepth){qi(),p.currentAnalysisId=p.engine.analysisId+1;try{await p.engine.analyzePosition(t,e)}catch(n){console.log("Engine analysis error:",n)}}function ge(){const t=Gt();xe(p.chess.fen(),p.maxDepth),Ut(),p.ground.set({fen:p.chess.fen(),turnColor:p.chess.turn()==="w"?"white":"black",movable:{color:p.chess.turn()==="w"?"white":"black",dests:t,free:!1,events:{after:(e,n,i)=>{const o=p.chess.move({from:e,to:n,promotion:i==null?void 0:i.promotion});Me(o),ge()}}}})}function Fi(){v.settingsFooter.style.display==="flex"?v.settingsFooter.style.display="none":v.settingsFooter.style.display="flex"}function we(t){const e=document.querySelector("cg-board");if(e){switch(e.style.backgroundImage="none",t){case"blue":e.style.backgroundImage="url('/images/blue.svg')";break;case"green":e.style.backgroundImage="url('/images/green.png')";break;case"brown":e.style.backgroundImage="url('/images/brown.png')";break;default:e.style.backgroundImage="url('/images/brown.png')"}v.blueButton.style.border=t==="blue"?"2px solid white":"2px solid transparent",v.greenButton.style.border=t==="green"?"2px solid white":"2px solid transparent",v.brownButton.style.border=t==="brown"?"2px solid white":"2px solid transparent",p.boardTheme=t}}async function Bi(){p.moveHistory=[{fen:p.chess.fen(),move:null}],p.currentMoveIndex=0;const t={coordinates:!1,viewOnly:!1};p.ground=pi(v.board,t),await p.engine.waitForReady(),window.addEventListener("resize",ht),v.settingsToggle.addEventListener("click",Fi),document.addEventListener("click",e=>{!v.settingsPopup.contains(e.target)&&e.target!==v.settingsToggle&&(v.settingsFooter.style.display="none")}),v.colorToggle.addEventListener("click",()=>{p.userIsWhite=!p.userIsWhite,p.ground.toggleOrientation(),v.icon.innerHTML=p.userIsWhite?'<path fill="white" stroke="black" stroke-width="2" d="M12 2L15 8H9L12 2ZM6 8L9 22H15L18 8H6ZM3 22H21V24H3V22Z"/>':'<path fill="black" stroke="black" stroke-width="2" d="M12 2L15 8H9L12 2ZM6 8L9 22H15L18 8H6ZM3 22H21V24H3V22Z"/>'}),document.addEventListener("keydown",e=>{e.key==="ArrowLeft"?(ze("prev"),e.preventDefault()):e.key==="ArrowRight"&&(ze("next"),e.preventDefault())}),v.searching.addEventListener("click",async()=>{try{Wt(v.username.value,v.websiteOrigin.value,p.userIsWhite?"white":"black",parseInt(v.months.value))}catch(e){console.error("Error fetching games:",e)}});for(let e=0;e<3;e++)v.lines[e].addEventListener("mouseenter",()=>{p.ground.set({drawable:{shapes:[{orig:p.lines[e].substring(0,2),dest:p.lines[e].substring(2,4),brush:"green"}]}})}),v.lines[e].addEventListener("mouseleave",()=>{p.ground.set({drawable:{shapes:[]}})}),v.lines[e].addEventListener("click",()=>{He(p.lines[e])});v.resizeHandle.addEventListener("mousedown",e=>{e.preventDefault();const n=200,i=Math.min(window.innerWidth*.7,window.innerHeight*.7);function o(s){let a=Math.min(s.clientX-v.container.offsetLeft,s.clientY-v.container.offsetTop);a=Math.max(n,a),a=Math.min(i,a),v.board.style.width=`${a}px`,v.board.style.height=`${a}px`,p.ground&&p.ground.redrawAll()}function r(){document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)}document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)}),document.addEventListener("explorer-san-move-selected",e=>{const{san:n}=e.detail;jt(n)}),document.addEventListener("explorer-uci-move-selected",e=>{const{uci:n}=e.detail;He(n)}),v.depthSlider.addEventListener("input",()=>{const e=parseInt(v.depthSlider.value,10);p.maxDepth=e,v.depthValue.textContent=e,xe(p.chess.fen(),p.maxDepth)}),v.blueButton.addEventListener("click",()=>we("blue")),v.greenButton.addEventListener("click",()=>we("green")),v.brownButton.addEventListener("click",()=>we("brown")),ht(),ge()}window.addEventListener("beforeunload",()=>{p.engine.dispose()});Bi();window.chessFunctions={makeMove:Oi,makeSanMove:jt,makeUCIMove:He,navigateMove:ze,initializeExplorer:Wt,updateBoardTheme:we,setEngineDepth:t=>{p.maxDepth=t,v.depthSlider.value=t,v.depthValue.textContent=t,xe(p.chess.fen(),t)}};
